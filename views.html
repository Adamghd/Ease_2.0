<script type='text/javascript'>

app.AppView = Backbone.View.extend({

	initialize: function() {

		$('#body').html('Loading...');

		// Create collections
		app.groupList = new app.GroupList();
		app.eventList = new app.EventList();
		app.transactionList = new app.TransactionList();
		app.paymentList = new app.PaymentList();
		app.projectList = new app.ProjectList();
		app.taskList = new app.TaskList();

		// Load user information
		google.script.run.withSuccessHandler(this.load)
			.getProfile();

	},
	load: function(json) {

		if (app.groupList.length === 0) {

			this.initialize();

		} else {

			var user_object = JSON.parse(json);
			User = user_object; // Set User object
			console.log(User);

			// Welcome user
			toastr.success("Hello " + User.email + "!");

			$('#body').html(' ');

			if (user_object.authorization === true) { // Is an authorized user

				var sidebar = new app.AuthorizedSidebarView();
				$('#body').append(sidebar.render().el);
				$('.profile .email').html(user_object.email);

				var dashboard = new app.DashboardView();
				$('#body').append(dashboard.render().el);

			}

		}

	},
	dashboard_view: function() {

		this.clearContent();
		var dashboard = new app.DashboardView();
		$('#body').append(dashboard.render().el);

	},
	scheduling_dashboard_view: function() {

		this.clearContent();
		var scheduling_dashboard = new app.SchedulingDashboardView();
		$('#body').append(scheduling_dashboard.render().el);

	},
	clearContent: function() {
		$('#main').remove();
	}

});

app.AuthorizedSidebarView = Backbone.View.extend({

	template: _.template($('#authorized_sidebar-template').html()),
	render: function() {
		this.$el.html(this.template());
		return this;
	},
	events: {

		'click .dashboard_view': 'dashboard_view',
		'click #scheduling_dashboard_click': 'scheduling_dashboard_click'

	},

	dashboard_view: function() {
		
		$('.nav').find('.active').removeClass('active');
		$('.dashboard_view').addClass('active');
		app.appView.dashboard_view();

	},

	scheduling_dashboard_click: function() {

		$('.nav').find('.active').removeClass('active');
		$('#scheduling_dashboard_click').addClass('active');
		app.appView.scheduling_dashboard_view();

	}

});

app.DashboardView = Backbone.View.extend({
	
	template: _.template($('#dashboard-template').html()),
	initialize: function() {
		this.listenTo(app.groupList, "change", this.render);
		this.listenTo(app.eventList, "change", this.render);
	},
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Num of groups
		this.$el.find('.num_groups').html(app.groupList.length);

		// Num of upcoming events
		var upcoming_events = app.eventList.getUpcomingEvents();
		this.$el.find('.num_upcoming_events').html(upcoming_events.length);

		// Num of projects
		this.$el.find('.num_projects').html(app.projectList.length);

		// Num of incomplete tasks
		var tasks = app.taskList.where({completed: false});
		this.$el.find('.num_incomplete_tasks').html(tasks.length);

		// Create calendar
		var proxy = this;
		var events = Helper.getAllEvents();

		this.$el.find('#dashboard-calendar').fullCalendar({
			events: events,
			defaultView: 'agendaWeek',
			timezone: 'local',
			eventClick: function(calEvent) {
				proxy.eventClick(calEvent);
			}
		});

		setTimeout(function() {
			$('#dashboard-calendar').fullCalendar('render');
		}, 10);

	},
	eventClick: function(calEvent) {

		var event = app.eventList.where({_id: calEvent.id});
		var group = app.groupList.where({_id: event[0].attributes.groupID});
		var view = new app.EventDetailView({model: {event: event[0], group: group[0]}});
		$('#modals').html(view.render().el);

	}
	
});

// Scheduling

app.SchedulingDashboardView = Backbone.View.extend({

	template: _.template($('#scheduling-dashboard-template').html()),
	initialize: function() {
		this.listenTo(app.groupList, "change", this.render);
		this.listenTo(app.eventList, "change", this.render);
	},
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Num of groups
		this.$el.find('.num_groups').html(app.groupList.length);

		// Num of upcoming events
		var upcoming_events = app.eventList.getUpcomingEvents();
		this.$el.find('.num_upcoming_events').html(upcoming_events.length);

		// Num of unpaid events
		var previous_events = app.eventList.getPreviousEvents();
		var unpaid_events = Helper.arrayWhere(previous_events, 'paidStatus', false);
		this.$el.find('.num_unpaid_events').html(unpaid_events.length);

		// Num of current attendence
		this.$el.find('.num_current_attendance').html('12,888');

		// Calendar
		var proxy = this;
		var events = Helper.getAllEvents();
		this.$el.find('#scheduling-dashboard-calendar').fullCalendar({
			events: events,
			timezone: 'local',
			eventClick: function(calEvent) {
				proxy.eventClick(calEvent);
			}
		});

		setTimeout(function() {
			$('#scheduling-dashboard-calendar').fullCalendar('render');
		}, 10);

		// Upcoming Shows | Get the next 4 shows
		var upcoming_events_list = app.eventList.getNextEvents();
		for (var i = 0; i < 4; i++) {
			this.addEventListItem(upcoming_events_list[i], '.event-list');
		}

	},
	eventClick: function(calEvent) {

		var event = app.eventList.where({_id: calEvent.id});
		var group = app.groupList.where({_id: event[0].attributes.groupID});
		var view = new app.EventDetailView({model: {event: event[0], group: group[0]}});
		$('#modals').html(view.render().el);

	},
	addEventListItem: function(event, element) {

		var group = app.groupList.where({_id: event.attributes.groupID});
		var view = new app.EventListView({model: {event: event, group: group[0]}});
		this.$el.find(element).append(view.render().el);

	}

});

app.EventListView = Backbone.View.extend({

	template: _.template($('#event-list-item-view').html()),
	initialize: function() {
		this.listenTo(this.model.event, "change", this.render);
		this.listenTo(this.model.group, "change", this.render);
	},
	render: function() {
		this.$el.html(this.template({event:this.model.event.attributes,group:this.model.group.attributes}));
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Check invoice status
		if (this.model.event.attributes.invoice_url !== undefined) { // Invoice url exists

			// Create invoice status checkboxes
			if (this.model.event.attributes.invoiceSent !== true || this.model.event.attributes.invoiceSent === undefined) {
				this.$el.find('.invoice_status').append("Invoice Sent: <input type='checkbox' class='invoice-sent' />&nbsp;&nbsp;&nbsp;");
			} else if (this.model.event.attributes.invoiceSent === true) {
				this.$el.find('.invoice_status').append("Invoice Sent! &nbsp;&nbsp;&nbsp;");
			}
			if (this.model.event.attributes.invoiceFiled !== true || this.model.event.attributes.invoiceFiled === undefined) {
				this.$el.find('.invoice_status').append("Invoice Filed: <input type='checkbox' class='invoice-filed' />");
			} else if (this.model.event.attributes.invoiceFiled === true) {
				this.$el.find('.invoice_status').append("Invoice Filed!");
			}

			// Set primary button
			this.$el.find('.event-invoice').addClass('event-view-invoice').removeClass('event-invoice').html('View Invoice');

		}

	},
	events: {
		'click .event-view': 'event_view',
		'change input:checkbox': 'change_status'
	},
	change_status: function(e) {

		var element = $(e.currentTarget).attr('class');

		if (element === 'invoice-sent') {
			this.model.event.set({
				invoiceSent: true
			});
		} else if (element === 'invoice-filed') {
			this.model.event.set({
				invoiceFiled: true
			});
		}

	},
	event_view: function() {

		var view = new app.EventDetailView({model: {event: this.model.event, group: this.model.group}});
		$('#modals').html(view.render().el);

	}

});

app.EventDetailView = Backbone.View.extend({

	template: _.template($('#event-detail-view').html()),
	initialize: function() {
		this.listenTo(this.model.event, "change", this.render);
		this.listenTo(this.model.group, "change", this.render);
	},
	render: function() {
		this.$el.html(this.template({event:this.model.event.attributes,group:this.model.group.attributes}));
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Create invoice status checkboxes
		if (this.model.event.attributes.invoiceSent !== true || this.model.event.attributes.invoiceSent === undefined) {
			this.$el.find('.invoice_status').append("Invoice Sent: <input type='checkbox' class='invoice-sent' />&nbsp;&nbsp;&nbsp;");
		} else if (this.model.event.attributes.invoiceSent === true) {
			this.$el.find('.invoice_status').append("Invoice Sent! &nbsp;&nbsp;&nbsp;");
		}
		if (this.model.event.attributes.invoiceFiled !== true || this.model.event.attributes.invoiceFiled === undefined) {
			this.$el.find('.invoice_status').append("Invoice Filed: <input type='checkbox' class='invoice-filed' />");
		} else if (this.model.event.attributes.invoiceFiled === true) {
			this.$el.find('.invoice_status').append("Invoice Filed!");
		}

		// Check invoice createion status
		if (this.model.event.attributes.invoice_url !== undefined) {
			this.$el.find('.event-invoice').addClass('event-view-invoice').removeClass('event-invoice').html('View Invoice');
		}

		setTimeout(function() {
			$('#modals .modal').modal('show');
		}, 10);

	},
	events: {
		'click .event-view': 'event_view',
		'change input:checkbox': 'change_status',
		'click .edit-group': 'edit_group',
		'click .save-group': 'save_group',
		'click .edit-event': 'edit_event',
		'click .save-event': 'save_event'
	},
	change_status: function(e) {

		var element = $(e.currentTarget).attr('class');

		if (element === 'invoice-sent') {
			this.model.event.set({
				invoiceSent: true
			});
		} else if (element === 'invoice-filed') {
			this.model.event.set({
				invoiceFiled: true
			});
		}

	},
	edit_group: function() {

		// Set edit row visible
		this.$el.find('div.static.group').css('display', 'none');
		this.$el.find('div.edit.group').css('display', 'block');

		// Change edit button to save
		this.$el.find('.edit-group').removeClass('edit-group').removeClass('btn-info').addClass('btn-success').addClass('save-group').html("<em class='fa fa-floppy-o'>&nbsp;</em> Save");

	},
	save_group: function() {

		// Get variables
		var groupName = this.$el.find('input.groupName').val();
		var groupGroup = this.$el.find('input.groupGroup').val();
		var groupType = this.$el.find('input.groupType').val();
		var grade = this.$el.find('input.grade').val();
		var email = this.$el.find('input.email').val();
		var cellPhone = this.$el.find('input.cellPhone').val();
		var workPhone = this.$el.find('input.workPhone').val();

		// Set to model
		this.model.group.set({
			groupName: groupName,
			groupGroup: groupGroup,
			groupType: groupType,
			grade: grade,
			email: email,
			cellPhone: cellPhone,
			workPhone: workPhone
		});

		// Set static row visible
		this.$el.find('div.static.group').css('display', 'block');
		this.$el.find('div.edit.group').css('display', 'none');

		// Change save button to edit
		this.$el.find('.save-group').removeClass('save-group').removeClass('btn-success').addClass('btn-info').addClass('edit-group').html("<em class='fa fa-pencil'>&nbsp;</em> Edit");

	},
	edit_event: function() {

		// Set edit row visible
		this.$el.find('div.static.event').css('display', 'none');
		this.$el.find('div.edit.event').css('display', 'block');

		// Change edit button to save
		this.$el.find('.edit-event').removeClass('edit-event').removeClass('btn-info').addClass('btn-success').addClass('save-event').html("<em class='fa fa-floppy-o'>&nbsp;</em> Save");

	},
	save_event: function() {

		// Get variables

	}


});

</script>