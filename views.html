<script type='text/javascript'>

app.AppView = Backbone.View.extend({

	initialize: function() {

		$('#body').html('Loading...');

		// Create collections
		app.groupList = new app.GroupList();
		app.eventList = new app.EventList();
		app.transactionList = new app.TransactionList();
		app.paymentList = new app.PaymentList();
		app.projectList = new app.ProjectList();
		app.taskList = new app.TaskList();

		// Load user information
		google.script.run.withSuccessHandler(this.load)
			.getProfile();

	},
	load: function(json) {

		var user_object = JSON.parse(json);
		User = user_object; // Set User object
		console.log(User);

		// Welcome user
		toastr.success("Hello " + User.email + "!");

		$('#body').html(' ');

		if (user_object.authorization === true) { // Is an authorized user

			var sidebar = new app.AuthorizedSidebarView();
			$('#body').append(sidebar.render().el);
			$('.profile .email').html(user_object.email);

			var dashboard = new app.DashboardView();
			$('#body').append(dashboard.render().el);

		}

	},
	dashboard_view: function() {

		this.clearContent();
		var dashboard = new app.DashboardView();
		$('#body').append(dashboard.render().el);

	},
	scheduling_dashboard_view: function() {

		this.clearContent();
		var scheduling_dashboard = new app.SchedulingDashboardView();
		$('#body').append(scheduling_dashboard.render().el);

	},
	clearContent: function() {
		$('#main').remove();
	}

});

app.AuthorizedSidebarView = Backbone.View.extend({

	template: _.template($('#authorized_sidebar-template').html()),
	render: function() {
		this.$el.html(this.template());
		return this;
	},
	events: {

		'click .dashboard_view': 'dashboard_view',
		'click #scheduling_dashboard_click': 'scheduling_dashboard_click'

	},

	dashboard_view: function() {
		
		$('.nav').find('.active').removeClass('active');
		$('.dashboard_view').addClass('active');
		app.appView.dashboard_view();

	},

	scheduling_dashboard_click: function() {

		$('.nav').find('.active').removeClass('active');
		$('#scheduling_dashboard_click').addClass('active');
		app.appView.scheduling_dashboard_view();

	}

});

app.DashboardView = Backbone.View.extend({
	
	template: _.template($('#dashboard-template').html()),
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Num of groups
		this.$el.find('.num_groups').html(app.groupList.length);

		// Num of upcoming events
		var upcoming_events = app.eventList.getUpcomingEvents();
		this.$el.find('.num_upcoming_events').html(upcoming_events.length);

		// Num of projects
		this.$el.find('.num_projects').html(app.projectList.length);

		// Num of incomplete tasks
		var tasks = app.taskList.where({completed: false});
		this.$el.find('.num_incomplete_tasks').html(tasks.length);

		// Create calendar
		var input = [];
		for (var i = 0; i < upcoming_events.length; i++) {

			var group = app.groupList.where({_id: upcoming_events[i].attributes.groupID});
			var object = {
				event: upcoming_events[i],
				group: group[0]
			};
			input.push(object);

		}

		var events = Helper.parseCalendarData(input);

		this.$el.find('#dashboard-calendar').fullCalendar({
			events: events,
			defaultView: 'agendaWeek'
		});

		setTimeout(function() {
			$('#dashboard-calendar').fullCalendar('render');
		}, 10);

	}
	
});

// Scheduling

app.SchedulingDashboardView = Backbone.View.extend({

	template: _.template($('#scheduling-dashboard-template').html()),
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this; // chained commands
	},
	load: function() {

		// Num of groups
		this.$el.find('.num_groups').html(app.groupList.length);

		// Num of upcoming events
		var upcoming_events = app.eventList.getUpcomingEvents();
		this.$el.find('.num_upcoming_events').html(upcoming_events.length);

		// Num of unpaid events
		var previous_events = app.eventList.getPreviousEvents();
		var unpaid_events = Helper.arrayWhere(previous_events, 'paidStatus', false);
		this.$el.find('.num_unpaid_events').html(unpaid_events.length);

		// Num of current attendence
		this.$el.find('.num_current_attendence').html('12,888');


	}

})

</script>