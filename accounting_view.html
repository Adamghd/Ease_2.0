<script type='text/javascript'>

app.AccountingDashboard = Backbone.View.extend({

	template: _.template($('#accounting-dashboard-template').html()),
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this;
	},
	load: function() {

		setTimeout(function() {

			// Income by month
			var ctx = document.getElementById('chart_month').getContext('2d');
			var chart = new Chart(ctx, {
			    // The type of chart we want to create
			    type: 'line',

			    // The data for our dataset
			    data: {
			        labels: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
			        datasets: [{
			            label: "Monthly Income",
			            backgroundColor: 'rgb(255, 97, 34)',
			            borderColor: 'rgb(255, 163, 126)',
			            data: [1482, 3189, 3128, 2568, 1911, 2450, 4370, 5544, 1825, 1202]
			        }]
			    },

			    // Configuration options go here
			    options: {
					plugins: {
						datalabels: {
							backgroundColor: function(context) {
								return context.dataset.backgroundColor;
							},
							borderRadius: 4,
							color: 'white',
							font: {
								weight: 'bold'
							},
							formatter: Math.round
						}
					},
					scales: {
						yAxes: [{
							stacked: true
						}]
					}			    	
			    }
			});

			// Total income
			var ctx = document.getElementById('chart_total').getContext('2d');
			var chart = new Chart(ctx, {
			    // The type of chart we want to create
			    type: 'line',

			    // The data for our dataset
			    data: {
			        labels: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
			        datasets: [{
			            label: "Yearly Income",
			            backgroundColor: 'rgb(255, 97, 34)',
			            borderColor: 'rgb(255, 163, 126)',
			            data: [1482, 4671, 7799, 10367, 12278, 14728, 19098, 24642, 26467, 27735],
			        }]
			    },

			    // Configuration options go here
			    options: {
					plugins: {
						datalabels: {
							backgroundColor: function(context) {
								return context.dataset.backgroundColor;
							},
							borderRadius: 4,
							color: 'white',
							font: {
								weight: 'bold'
							},
							formatter: Math.round
						}
					},
					scales: {
						yAxes: [{
							stacked: true
						}]
					}			    	
			    }
			});

			// Transaction type
			var ctx = document.getElementById('chart_transaction_type').getContext('2d');
			var chart = new Chart(ctx, {
			    // The type of chart we want to create
			    type: 'doughnut',

			    // The data for our dataset
			    data: {
			        labels: ["Cash", "Checks", "Credit Cards"],
			        datasets: [{
				        backgroundColor: [
				        	'rgb(242, 164, 14)',
				        	'rgb(181, 55, 55)',
				        	'rgb(0, 127, 161)',
				        	'rgb(0, 161, 103)'
				        ],
			        	data: [7817, 13853, 5197]
			        }]
			    },

			    // Configuration options go here
				options: {
					plugins: {
						datalabels: {
							backgroundColor: function(context) {
								return context.dataset.backgroundColor;
							},
							borderColor: 'white',
							borderRadius: 25,
							borderWidth: 2,
							color: 'white',
							display: function(context) {
								var dataset = context.dataset;
								var count = dataset.data.length;
								var value = dataset.data[context.dataIndex];
								return value > count * 1.5;
							},
							font: {
								weight: 'bold'
							},
							formatter: Math.round
						}
					}
				}
			});			

			// Grup type
			var ctx = document.getElementById('chart_group_type').getContext('2d');
			var chart = new Chart(ctx, {
			    // The type of chart we want to create
			    type: 'bar',

			    // The data for our dataset
			    data: {
			        labels: ["Astrobreak", "Class", "Observing", "Private", "Public", "School", "UWM"],
			        datasets: [{
			            label: "Income by group type",
				        backgroundColor: [
				        	'rgb(242, 164, 14)',
				        	'rgb(181, 55, 55)',
				        	'rgb(0, 127, 161)',
				        	'rgb(0, 161, 103)',
				        	'rgb(57, 221, 158)',
				        	'rgb(1, 181, 175)',
				        	'rgb(43, 113, 160)'
				        ],
			        	data: [0, 0, -310, 5639, 13021, 7520, 0]
			        }]
			    },

			    // Configuration options go here
				options: {
					plugins: {
						datalabels: {
							color: 'white',
							display: function(context) {
								return context.dataset.data[context.dataIndex] > 15;
							},
							font: {
								weight: 'bold'
							},
							formatter: Math.round
						}
					},
					scales: {
						xAxes: [{
							stacked: true
						}],
						yAxes: [{
							stacked: true
						}]
					}
				}
			});		

		}, 20);

	},
	events: {
		'click .reload_graphs': 'load'
	}

});

app.TransactionView = Backbone.View.extend({

	template: _.template($('#transaction-view-template').html()),
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this;
	},
	load: function() {

		// Load the transactions
		for (var i = 0; i < app.transactionList.length; i++) {

			this.renderTransaction(app.transactionList.models[i]);

		}

	},
	renderTransaction: function(transaction) {

		var view = new app.TransactionListItem({model: transaction});
		this.$el.find('.transaction_land').append(view.render().el);

	}

});

app.TransactionListItem = Backbone.View.extend({

	template: _.template($('#transaction-list-template').html()),
	model: app.TransactionModel,
	render: function() {
		this.$el.html(this.template(this.model.toJSON()));
		this.load();
		return this;
	},
	load: function() {

	}

});

app.TransactionDetailView = Backbone.View.extend({

	template: _.template($('#transaction-detail-view-template').html()),
	render: function() {
		if (this.model.event) {
			this.$el.html(this.template({transaction: this.model.transaction.attributes, event: this.model.event.attributes, group: this.model.group.attributes}));
		} else {
			this.$el.html(this.template({transaction: this.model.transaction}));
		}
		this.load();
		return this;
	},
	load: function() {

		// Get payments
		var payments = app.paymentList.where({transactionID: this.model.transaction.attributes._id});
		console.log(payments);

		for (var i = 0; i < payments.length; i++) {

			console.log(payments[i]);
			this.loadPayment(payments[i]);

		}

		setTimeout(function() {
			$('#modals .modal').modal('show');
		}, 10);

	},
	loadPayment: function(payment) {

		var view = new app.PaymentDetailView({model: payment});
		this.$el.find('.payment-land').append(view.render().el);

	}

});

app.PaymentDetailView = Backbone.View.extend({

	template: _.template($('#payment-detail-view-template').html()),
	render: function() {
		this.$el.html(this.template(this.model.toJSON()));
		this.load();
		return this;
	},
	load: function() {

	}

});

app.PaymentView = Backbone.View.extend({

	template: _.template($('#payment-view-template').html()),
	render: function() {
		this.$el.html(this.template());
		this.load();
		return this;
	},
	load: function() {

		for (var i = 0; i < app.paymentList.length; i++) {

			this.renderPayment(app.paymentList.models[i]);

		}

	},
	renderPayment: function(payment) {

		var view = new app.PaymentListItem({model: payment});
		this.$el.find('.payment_land').append(view.render().el);

	}

});

app.PaymentListItem = Backbone.View.extend({

	template: _.template($('#payment-list-template').html()),
	model: app.PaymentModel,
	render: function() {
		this.$el.html(this.template(this.model.toJSON()));
		this.load();
		return this;
	},
	load: function() {

	}

});

</script>